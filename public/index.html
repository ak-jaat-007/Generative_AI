<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Assistant</title>
<style>
  :root {
    --primary-color: #10a37f;
    --primary-hover: #0d8c6d;
    --sidebar-bg: #202123;
    --chat-bg: #343541;
    --message-user-bg: #343541;
    --message-bot-bg: #444654;
    --text-primary: #ececf1;
    --text-secondary: #acacbe;
    --text-muted: #6e6e80;
    --border-color: #4e4e60;
    --input-bg: #40414f;
    --button-bg: #10a37f;
    --button-hover: #0d8c6d;
    --danger-color: #ef4444;
    --danger-hover: #dc2626;
    --model-selector-bg: #2b2c2f;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: var(--chat-bg);
    color: var(--text-primary);
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  .sidebar {
    width: 260px;
    background-color: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: width 0.2s ease;
    overflow: hidden;
  }

  .sidebar.collapsed {
    width: 0;
    min-width: 0;
  }

  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
  }

  .new-chat-button {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: transparent;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s;
  }

  .new-chat-button:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  .new-chat-button svg {
    width: 16px;
    height: 16px;
  }

  .history-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .history-title {
    font-size: 0.8rem;
    padding: 8px 12px;
    color: var(--text-muted);
    margin-top: 15px;
  }

  .history-item {
    padding: 10px 12px;
    margin: 4px 0;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--text-secondary);
    transition: background-color 0.2s;
  }

  .history-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  .history-item.active {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .history-item svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .history-item-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border-color);
  }

  .clear-history-button {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: transparent;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s;
  }

  .clear-history-button:hover {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
  }

  .toggle-sidebar {
    position: absolute;
    top: 12px;
    left: 100%;
    background: var(--sidebar-bg);
    border: 1px solid var(--border-color);
    border-radius: 0 4px 4px 0;
    width: 24px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
  }

  .toggle-sidebar svg {
    width: 16px;
    height: 16px;
  }

  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .chat-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: var(--sidebar-bg);
  }

  .model-selector {
    padding: 6px 10px;
    border-radius: 4px;
    background-color: var(--model-selector-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    cursor: pointer;
  }

  .chat-title {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .message {
    display: flex;
    gap: 20px;
    padding: 20px 0;
  }

  .message.user {
    background-color: var(--message-user-bg);
  }

  .message.bot {
    background-color: var(--message-bot-bg);
  }

  .avatar {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
  }

  .avatar.user {
    background: linear-gradient(135deg, #5436da, #5c61f0);
  }

  .avatar.bot {
    background: linear-gradient(135deg, #10a37f, #1dbc99);
  }

  .message-content {
    flex: 1;
    line-height: 1.6;
  }

  .message-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .message:hover .message-actions {
    opacity: 1;
  }

  .message-action-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.9rem;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .message-action-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
  }

  .input-container {
    padding: 16px;
    position: relative;
    border-top: 1px solid var(--border-color);
    background: var(--chat-bg);
  }

  .input-box {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--input-bg);
    display: flex;
    align-items: flex-end;
    padding: 8px 12px;
    position: relative;
  }

  .input-box:focus-within {
    outline: 1px solid var(--primary-color);
  }

  #question {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text-primary);
    resize: none;
    padding: 8px 0;
    min-height: 24px;
    max-height: 200px;
    font-family: inherit;
    line-height: 1.5;
  }

  .input-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-left: 8px;
  }

  .action-button {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
    border-radius: 4px;
    transition: background-color 0.2s, color 0.2s;
  }

  .action-button:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
  }

  .send-button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
  }

  .send-button:hover {
    background-color: var(--primary-hover);
  }

  .send-button:disabled {
    background-color: var(--text-muted);
    cursor: not-allowed;
  }

  .typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-top: 8px;
  }

  .typing-dot {
    width: 6px;
    height: 6px;
    background-color: var(--text-muted);
    border-radius: 50%;
    animation: typing-animation 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) {
    animation-delay: 0s;
  }

  .typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing-animation {
    0%, 60%, 100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-5px);
    }
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background-color: var(--sidebar-bg);
    border-radius: 8px;
    padding: 20px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .modal-title {
    font-size: 1.2rem;
    font-weight: 600;
  }

  .close-modal {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 1.5rem;
    line-height: 1;
  }

  .modal-body {
    margin-bottom: 20px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .modal-button {
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: 500;
  }

  .modal-button.primary {
    background-color: var(--primary-color);
    color: white;
  }

  .modal-button.primary:hover {
    background-color: var(--primary-hover);
  }

  .modal-button.secondary {
    background-color: transparent;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .modal-button.secondary:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .sidebar {
      position: absolute;
      z-index: 100;
      height: 100%;
    }
    
    .sidebar:not(.collapsed) {
      width: 100%;
      max-width: 300px;
    }
    
    .message {
      padding: 16px 12px;
    }
    
    .messages {
      padding: 10px;
    }
  }

  /* Markdown styling for AI responses */
  .message-content h1, .message-content h2, .message-content h3 {
    margin: 1em 0 0.5em 0;
    font-weight: 600;
  }

  .message-content p {
    margin: 0.8em 0;
  }

  .message-content ul, .message-content ol {
    margin: 0.8em 0;
    padding-left: 1.5em;
  }

  .message-content code {
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: monospace;
  }

  .message-content pre {
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.8em;
    border-radius: 5px;
    overflow-x: auto;
    margin: 0.8em 0;
  }

  .message-content pre code {
    background: none;
    padding: 0;
  }

  .message-content blockquote {
    border-left: 3px solid var(--text-muted);
    padding-left: 1em;
    margin: 1em 0;
    color: var(--text-secondary);
  }

  .message-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 1em 0;
  }

  .message-content th, .message-content td {
    border: 1px solid var(--border-color);
    padding: 0.5em;
  }

  .message-content th {
    background-color: rgba(255, 255, 255, 0.05);
  }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <button class="new-chat-button" onclick="newChat()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      New chat
    </button>
  </div>
  <div class="history-container" id="history-container">
    <div class="history-title">Today</div>
    <div class="history" id="history"></div>
  </div>
  <div class="sidebar-footer">
    <button class="clear-history-button" onclick="showClearHistoryModal()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Clear conversations
    </button>
  </div>
  <div class="toggle-sidebar" onclick="toggleSidebar()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
</div>

<div class="chat-container">
  <div class="chat-header">
    <select class="model-selector" id="provider">
      <option value="openai">OpenAI GPT-4</option>
      <option value="gemini" selected>Gemini Pro</option>
      <option value="claude">Claude 2</option>
      <option value="deepseek">DeepSeek Coder</option>
    </select>
    <div class="chat-title" id="chat-title">New Chat</div>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-container">
    <div class="input-box">
      <textarea id="question" placeholder="Message AI assistant..." rows="1"></textarea>
      <div class="input-actions">
        <button class="action-button" onclick="startVoice()" title="Voice input">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" x2="12" y1="19" y2="22"></line>
          </svg>
        </button>
        <button class="action-button" onclick="attachFile()" title="Attach file">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
          </svg>
        </button>
        <button class="send-button" id="send-button" onclick="sendMessage()" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
        </button>
      </div>
    </div>
    <div class="typing-indicator" id="typing-indicator" style="display: none;">
      <span>AI is thinking</span>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  </div>
</div>

<!-- Clear History Confirmation Modal -->
<div class="modal" id="clear-history-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Clear all conversations?</h3>
      <button class="close-modal" onclick="closeModal('clear-history-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p>This will permanently remove all your conversation history. This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="modal-button secondary" onclick="closeModal('clear-history-modal')">Cancel</button>
      <button class="modal-button primary" onclick="clearHistory()">Clear conversations</button>
    </div>
  </div>
</div>

<script>
  // DOM elements
  const messagesDiv = document.getElementById("messages");
  const historyDiv = document.getElementById("history");
  const questionInput = document.getElementById("question");
  const sendButton = document.getElementById("send-button");
  const providerSelect = document.getElementById("provider");
  const typingIndicator = document.getElementById("typing-indicator");
  const chatTitle = document.getElementById("chat-title");
  
  // State variables
  let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];
  let currentChatId = null;
  let isGenerating = false;
  let abortController = null;

  // Initialize the app
  function init() {
    renderHistory();
    questionInput.addEventListener("input", handleInputChange);
    questionInput.addEventListener("keydown", handleKeyDown);
    adjustTextareaHeight();
    
    // Load last active chat if exists
    const lastChatId = localStorage.getItem("lastChatId");
    if (lastChatId) {
      loadChat(lastChatId);
    }
  }

  // Handle input change
  function handleInputChange() {
    adjustTextareaHeight();
    sendButton.disabled = questionInput.value.trim() === "";
  }

  // Handle keydown events
  function handleKeyDown(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      if (!sendButton.disabled) {
        sendMessage();
      }
    }
  }

  // Adjust textarea height based on content
  function adjustTextareaHeight() {
    questionInput.style.height = "auto";
    questionInput.style.height = Math.min(questionInput.scrollHeight, 200) + "px";
  }

  // Create a new chat
  function newChat() {
    currentChatId = Date.now().toString();
    messagesDiv.innerHTML = "";
    chatTitle.textContent = "New Chat";
    questionInput.value = "";
    questionInput.focus();
    adjustTextareaHeight();
    sendButton.disabled = true;
    
    // Save to localStorage
    localStorage.setItem("lastChatId", currentChatId);
  }

  // Load a specific chat
  function loadChat(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    
    currentChatId = chatId;
    messagesDiv.innerHTML = "";
    
    // Render messages
    chat.messages.forEach(msg => {
      appendMessage(msg.content, msg.role);
    });
    
    // Update UI
    chatTitle.textContent = chat.title || "Chat";
    
    // Update active state in history
    document.querySelectorAll(".history-item").forEach(item => {
      item.classList.remove("active");
      if (item.dataset.chatId === chatId) {
        item.classList.add("active");
      }
    });
    
    // Save to localStorage
    localStorage.setItem("lastChatId", currentChatId);
  }

  // Append message to chat
  function appendMessage(text, sender) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", sender);
    
    const avatar = document.createElement("div");
    avatar.classList.add("avatar", sender);
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    
    const contentDiv = document.createElement("div");
    contentDiv.classList.add("message-content");
    
    // Format message with markdown if it's from the bot
    if (sender === 'bot') {
      contentDiv.innerHTML = formatMessage(text);
    } else {
      contentDiv.textContent = text;
    }
    
    const actionsDiv = document.createElement("div");
    actionsDiv.classList.add("message-actions");
    
    if (sender === 'user') {
      const editBtn = document.createElement("button");
      editBtn.classList.add("message-action-btn");
      editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
      editBtn.title = 'Edit';
      editBtn.onclick = () => {
        questionInput.value = text;
        questionInput.focus();
        adjustTextareaHeight();
      };
      actionsDiv.appendChild(editBtn);
      
      const copyBtn = document.createElement("button");
      copyBtn.classList.add("message-action-btn");
      copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
      copyBtn.title = 'Copy';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(text);
        showToast('Message copied to clipboard');
      };
      actionsDiv.appendChild(copyBtn);
    } else if (sender === 'bot') {
      const thumbsUpBtn = document.createElement("button");
      thumbsUpBtn.classList.add("message-action-btn");
      thumbsUpBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>';
      thumbsUpBtn.title = 'Good response';
      thumbsUpBtn.onclick = () => showToast('Feedback submitted');
      actionsDiv.appendChild(thumbsUpBtn);
      
      const thumbsDownBtn = document.createElement("button");
      thumbsDownBtn.classList.add("message-action-btn");
      thumbsDownBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.28a2 2 0 0 1 2 1.7l1.38 9a2 2 0 0 1-2 2.3H17"></path></svg>';
      thumbsDownBtn.title = 'Poor response';
      thumbsDownBtn.onclick = () => showToast('Feedback submitted');
      actionsDiv.appendChild(thumbsDownBtn);
      
      const copyBtn = document.createElement("button");
      copyBtn.classList.add("message-action-btn");
      copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
      copyBtn.title = 'Copy';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(text);
        showToast('Response copied to clipboard');
      };
      actionsDiv.appendChild(copyBtn);
    }
    
    msgDiv.appendChild(avatar);
    msgDiv.appendChild(contentDiv);
    msgDiv.appendChild(actionsDiv);
    
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Format message with simple markdown
  function formatMessage(text) {
    // Convert **bold** to <strong>bold</strong>
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert *italic* to <em>italic</em>
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Convert `code` to <code>code</code>
    text = text.replace(/`(.*?)`/g, '<code>$1</code>');
    
    // Convert ```code blocks``` to <pre><code>code</code></pre>
    text = text.replace(/```([^`]*)```/g, '<pre><code>$1</code></pre>');
    
    // Convert line breaks
    text = text.replace(/\n/g, '<br>');
    
    return text;
  }

  // Update chat history
  function updateHistory(question, provider, answer) {
    // Create new chat if doesn't exist
    if (!currentChatId) {
      currentChatId = Date.now().toString();
    }
    
    // Find or create chat
    let chat = chatHistory.find(c => c.id === currentChatId);
    if (!chat) {
      chat = {
        id: currentChatId,
        title: question.length > 30 ? question.substring(0, 30) + "..." : question,
        provider: provider,
        messages: [],
        timestamp: Date.now()
      };
      chatHistory.unshift(chat);
    }
    
    // Add messages to chat
    chat.messages.push({
      role: 'user',
      content: question,
      timestamp: Date.now()
    });
    
    chat.messages.push({
      role: 'bot',
      content: answer,
      timestamp: Date.now()
    });
    
    // Update title if this is the first message
    if (chat.messages.length === 2) {
      chat.title = question.length > 30 ? question.substring(0, 30) + "..." : question;
    }
    
    // Update timestamp
    chat.timestamp = Date.now();
    
    // Save to localStorage
    localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    localStorage.setItem("lastChatId", currentChatId);
    
    // Update UI
    renderHistory();
    chatTitle.textContent = chat.title;
  }

  // Render chat history
  function renderHistory() {
    historyDiv.innerHTML = "";
    
    // Sort chats by timestamp (newest first)
    const sortedChats = [...chatHistory].sort((a, b) => b.timestamp - a.timestamp);
    
    // Group by date
    const today = new Date().setHours(0, 0, 0, 0);
    const yesterday = today - 86400000;
    
    const todayChats = sortedChats.filter(chat => new Date(chat.timestamp).setHours(0, 0, 0, 0) === today);
    const yesterdayChats = sortedChats.filter(chat => new Date(chat.timestamp).setHours(0, 0, 0, 0) === yesterday);
    const olderChats = sortedChats.filter(chat => {
      const chatDate = new Date(chat.timestamp).setHours(0, 0, 0, 0);
      return chatDate < yesterday;
    });
    
    // Render today's chats
    if (todayChats.length > 0) {
      const title = document.createElement("div");
      title.classList.add("history-title");
      title.textContent = "Today";
      historyDiv.appendChild(title);
      
      todayChats.forEach(chat => {
        historyDiv.appendChild(createHistoryItem(chat));
      });
    }
    
    // Render yesterday's chats
    if (yesterdayChats.length > 0) {
      const title = document.createElement("div");
      title.classList.add("history-title");
      title.textContent = "Yesterday";
      historyDiv.appendChild(title);
      
      yesterdayChats.forEach(chat => {
        historyDiv.appendChild(createHistoryItem(chat));
      });
    }
    
    // Render older chats
    if (olderChats.length > 0) {
      const title = document.createElement("div");
      title.classList.add("history-title");
      title.textContent = "Previous 7 Days";
      historyDiv.appendChild(title);
      
      olderChats.forEach(chat => {
        historyDiv.appendChild(createHistoryItem(chat));
      });
    }
    
    // Highlight active chat
    if (currentChatId) {
      const activeItem = document.querySelector(`.history-item[data-chat-id="${currentChatId}"]`);
      if (activeItem) {
        activeItem.classList.add("active");
      }
    }
  }

  // Create history item element
  function createHistoryItem(chat) {
    const div = document.createElement("div");
    div.classList.add("history-item");
    div.dataset.chatId = chat.id;
    
    const icon = document.createElement("div");
    icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>';
    
    const textSpan = document.createElement("span");
    textSpan.classList.add("history-item-text");
    textSpan.textContent = chat.title;
    
    div.appendChild(icon);
    div.appendChild(textSpan);
    
    div.onclick = () => loadChat(chat.id);
    
    return div;
  }

  // Clear chat history
  function clearHistory() {
    chatHistory = [];
    currentChatId = null;
    localStorage.removeItem("chatHistory");
    localStorage.removeItem("lastChatId");
    renderHistory();
    messagesDiv.innerHTML = "";
    chatTitle.textContent = "New Chat";
    closeModal('clear-history-modal');
  }

  // Show modal
  function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
  }

  // Close modal
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  // Show clear history modal
  function showClearHistoryModal() {
    showModal('clear-history-modal');
  }

  // Toggle sidebar
  function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('collapsed');
  }

  // Show toast notification
  function showToast(message) {
    // Create toast element if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.position = 'fixed';
      toast.style.bottom = '20px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.backgroundColor = 'var(--sidebar-bg)';
      toast.style.color = 'var(--text-primary)';
      toast.style.padding = '10px 20px';
      toast.style.borderRadius = '4px';
      toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
      toast.style.zIndex = '1000';
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s';
      document.body.appendChild(toast);
    }
    
    // Set message and show
    toast.textContent = message;
    toast.style.opacity = '1';
    
    // Hide after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
    }, 3000);
  }

  // Start voice input
  function startVoice() {
    if (!('webkitSpeechRecognition' in window)) {
      showToast("Your browser does not support voice input");
      return;
    }
    
    const recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    // Add visual feedback for listening
    const voiceButton = document.querySelector('.action-button[title="Voice input"]');
    voiceButton.style.color = 'var(--primary-color)';
    
    recognition.start();
    
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      questionInput.value = transcript;
      adjustTextareaHeight();
      sendButton.disabled = false;
      voiceButton.style.color = '';
    };
    
    recognition.onerror = function(event) {
      console.error(event.error);
      voiceButton.style.color = '';
      showToast("Voice input error: " + event.error);
    };
    
    recognition.onend = function() {
      voiceButton.style.color = '';
    };
  }

  // Attach file (placeholder)
  function attachFile() {
    showToast("File attachment feature coming soon");
  }

  // Send message to AI
  async function sendMessage() {
    const provider = providerSelect.value;
    const question = questionInput.value.trim();
    if (!question || isGenerating) return;
    
    // Add user message to chat
    appendMessage(question, "user");
    questionInput.value = "";
    adjustTextareaHeight();
    sendButton.disabled = true;
    
    // Show typing indicator
    typingIndicator.style.display = "flex";
    isGenerating = true;
    
    // Create abort controller for stopping generation
    abortController = new AbortController();
    
    try {
      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, prompt: question }),
        signal: abortController.signal
      });
      
      const data = await res.json();
      typingIndicator.style.display = "none";
      appendMessage(data.response, "bot");
      updateHistory(question, provider, data.response);
    } catch (err) {
      if (err.name === 'AbortError') {
        typingIndicator.style.display = "none";
        showToast("Request cancelled");
      } else {
        typingIndicator.style.display = "none";
        appendMessage("Error: " + err.message, "bot");
      }
    } finally {
      isGenerating = false;
      abortController = null;
    }
  }

  // Stop generating response
  function stopGenerating() {
    if (isGenerating && abortController) {
      abortController.abort();
    }
  }

  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>